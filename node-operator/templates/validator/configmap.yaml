{{- if .Values.validator.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "node-operator.fullname" . }}-validator-configs
  labels:
    {{- include "node-operator.labels" . | nindent 4 }}
    {{- include "validator.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
data:
  keymanageropts.json: |-
    {
        "direct_eip_version": "EIP-2335",
        "direct_version": "2"
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "node-operator.fullname" . }}-validator-init
  labels:
    {{- include "node-operator.labels" . | nindent 4 }}
    {{- include "validator.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
data:
  entrypoint.sh: |
    #!/bin/sh
    mkdir -p /data/prysm/.eth2validators/prysm-wallet-v2/direct/accounts
    mkdir -p /data/lighthouse/validators
    cp /mnt/configs/keymanageropts.json /data/prysm/.eth2validators/prysm-wallet-v2/direct/keymanageropts.json
    {{- if $.Values.vault.enabled }}
    cp /mnt/vault/prysm_keystore /data/prysm/.eth2validators/prysm-wallet-v2/direct/accounts/
    cp /mnt/vault/prysm_password /data/prysm/.eth2validators/password.txt
    cp /mnt/vault/lighthouse_keystore /data/lighthouse/validators/${VALIDATOR_PUBLICKEY}/voting-keystore.json
    cp /mnt/vault/lighthouse_password /data/lighthouse/validators/validator_definitions.yaml
    {{- else }}
    cp /mnt/secrets/all-accounts.keystore.json /data/prysm/.eth2validators/prysm-wallet-v2/direct/accounts/
    cp /mnt/secrets/password.txt /data/prysm/.eth2validators/password.txt
    cp /mnt/secrets/voting-keystore.json /data/lighthouse/validators/${VALIDATOR_PUBLICKEY}/voting-keystore.json
    cp /mnt/secrets/validator_definitions.yaml /data/lighthouse/validators/validator_definitions.yaml
    {{- end }}
{{ end }}
