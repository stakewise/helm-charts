{{- if and .Values.vault.enabled .Values.vault.csi.enabled -}}
{{- $root := . -}}
---
apiVersion: secrets-store.csi.x-k8s.io/v1alpha1
kind: SecretProviderClass
metadata:
  name: {{ template "node-operator.fullname" . }}-validator-secrets
  labels:
    {{- include "node-operator.labels" . | nindent 4 }}
    {{- include "common.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
spec:
  provider: vault
  parameters:
    vaultAddress: "http://{{ template "node-operator.fullname" . }}-vault:8200"
    roleName: "node-operator"
    objects: |
    {{- range (untilStep 0 (int .Values.validator.replicas) 1) }}
      - objectName: lighthouse_keystore
        secretPath: validators/data/validator-{{.}}/
        secretKey: lighthouse_keystore
      - objectName: lighthouse_password
        secretPath: validators/data/validator-{{.}}/
        secretKey: lighthouse_password
      - objectName: prysm_keystore
        secretPath: validators/data/validator-{{.}}/
        secretKey: prysm_keystore
      - objectName: prysm_password
        secretPath: validators/data/validator-{{.}}/
        secretKey: prysm_password
      - objectName: publickey
        secretPath: validators/data/validator-{{.}}/
        secretKey: publickey
    {{- end }}
{{- end }}
