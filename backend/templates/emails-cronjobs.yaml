{{- if .Values.emailCronJobs.enabled }}
{{ range $cronJob := .Values.emailCronJobs.deployments }}
{{- $name := $cronJob.command | replace "_" "-" -}}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{ template "emails.fullname" $ }}-{{ $name }}
  labels:
    {{- include "backend.labels" . | nindent 4 }}
    component: "{{ $name }}"
spec:
  schedule: {{ $cronJob.schedule | quote }}
  concurrencyPolicy: Forbid
{{- if $cronJob.failedJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ $cronJob.failedJobsHistoryLimit }}
{{- end }}
{{- if $cronJob.successfulJobsHistoryLimit }}
  successfulJobsHistoryLimit: {{ $cronJob.successfulJobsHistoryLimit }}
{{- end }}
  jobTemplate:
    metadata:
      labels:
        {{- include "backend.selectorLabels" . | nindent 8 }}
        component: "{{ $name }}"
    spec:
      template:
        metadata:
          labels:
            {{- include "backend.labels" . | nindent 12 }}
            component: "{{ $name }}"
          annotations:
            checksum/common-secret: {{ include (print $.Template.BasePath "/common-secret.yaml") $ | sha256sum }}
            checksum/common-configmap: {{ include (print $.Template.BasePath "/common-configmap.yaml") $ | sha256sum }}
        spec:
        {{- if $.Values.emailCronJobs.tolerations }}
          tolerations:
            {{ tpl $.Values.emailCronJobs.tolerations $ | nindent 12 | trim }}
        {{- end }}
        {{- if $.Values.emailCronJobs.affinity }}
          affinity:
            {{ tpl $.Values.emailCronJobs.affinity $ | nindent 12 | trim }}
        {{- end }}
        {{- with $.Values.securityContext }}
          securityContext:
            {{ toYaml . | nindent 12 | trim }}
        {{- end }}
          serviceAccountName: {{ template "emails.fullname" $ }}
          priorityClassName: {{ $cronJob.priorityClassName | quote }}
          restartPolicy: Never
          containers:
            - name: {{ $.Chart.Name }}
              image: "{{ $.Values.image.repository }}:{{ $.Values.image.tag }}"
              imagePullPolicy: {{ $.Values.image.pullPolicy }}
              command: ["python", "manage.py", "{{ $cronJob.command }}"]
              envFrom:
                - secretRef:
                    name: {{ template "backend.fullname" $ }}
                - configMapRef:
                    name: {{ template "backend.fullname" $ }}
              env:
                - name: DJANGO_SETTINGS_MODULE
                  value: "server.common_conf"
                - name: MAILER_USE_FILE_LOCK
                  value: "False"
            {{- with $cronJob.resources }}
              resources:
                {{ toYaml . | nindent 16 | trim }}
            {{- end }}
---
{{- end }}
{{- end }}
